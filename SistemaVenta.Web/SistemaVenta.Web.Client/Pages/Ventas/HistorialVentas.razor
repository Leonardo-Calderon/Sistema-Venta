@page "/ventas/historial"
@using Microsoft.AspNetCore.Authorization
@using Shared.DTOs
@using SistemaVenta.Web.Client.Services.Interfaces
@inject IVentaService ventaService
@inject NavigationManager NavigationManager

@attribute [Authorize]

<div class="card">
    <div class="card-header">
        <h5>Historial de Ventas</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end mb-3">
            <div class="col-sm-3">
                <label class="form-label">Fecha Inicio:</label>
                <input type="date" class="form-control" @bind="fechaInicio" />
            </div>
            <div class="col-sm-3">
                <label class="form-label">Fecha Fin:</label>
                <input type="date" class="form-control" @bind="fechaFin" />
            </div>
            <div class="col-sm-4">
                <label class="form-label">Buscar:</label>
                <input type="text" class="form-control" placeholder="Buscar por Nro. Venta o Cliente" @bind="busqueda" />
            </div>
            <div class="col-sm-2">
                <button class="btn btn-primary w-100" @onclick="Buscar">
                    <i class="oi oi-magnifying-glass"></i> Buscar
                </button>
            </div>
        </div>

        @if (ventas == null)
        {
            <div class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Fecha Registro</th>
                            <th>Nro. Venta</th>
                            <th>Usuario</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var venta in ventas)
                        {
                            <tr>
                                <td>@venta.FechaRegistro</td>
                                <td>@venta.NumeroVenta</td>
                                <td>@venta.NombreUsuario</td>
                                <td>@venta.NombreCliente</td>
                                <td>$@venta.PrecioTotal.ToString("N2")</td>
                                <td>
                                    <button class="btn btn-info btn-sm" @onclick="() => VerDetalle(venta.NumeroVenta)">
                                        <i class="oi oi-eye"></i> Ver
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@code {
    private List<VentaDTO> ventas;

    // --- CORRECCIÓN CLAVE: Usar DateTime para el enlace de datos ---
    private DateTime fechaInicio = DateTime.Now;
    private DateTime fechaFin = DateTime.Now;

    private string busqueda = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CargarVentas();
    }

    private async Task CargarVentas()
    {
        // Se convierten las fechas a string con el formato esperado ("dd/MM/yyyy")
        // justo antes de enviarlas a la API.
        var inicioFormateado = fechaInicio.ToString("dd/MM/yyyy");
        var finFormateado = fechaFin.ToString("dd/MM/yyyy");

        ventas = await ventaService.Historial(inicioFormateado, finFormateado, busqueda);
    }

    private async Task Buscar()
    {
        ventas = null; // Para mostrar el spinner de carga
        await CargarVentas();
    }

    private void VerDetalle(string numeroVenta)
    {
        NavigationManager.NavigateTo($"/ventas/detalle/{numeroVenta}");
    }
}